name: Lint and SAST

on:
  workflow_call:
    inputs:
      folder:
        required: true
        type: string

jobs:
  lint-and-sast:
    runs-on: ubuntu-latest
    env:
      FOLDER: ${{ inputs.folder }}

    steps:
      - uses: actions/checkout@v4

      - name: Validate folder input
        run: |
          case "$FOLDER" in
            next-frontend|spring-backend|android-kotlin|llm-backend) ;;
            *) echo "Invalid folder: $FOLDER"; exit 1 ;;
          esac

      - name: Setup Node.js
        if: env.FOLDER == 'next-frontend'
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Cache Node dependencies
        if: env.FOLDER == 'next-frontend'
        uses: actions/cache@v4
        with:
          path: ${{ env.FOLDER }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles(format('{0}/package-lock.json', env.FOLDER)) }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Setup Java (Spring & Android)
        if: env.FOLDER == 'spring-backend' || env.FOLDER == 'android-kotlin'
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          cache: ${{ env.FOLDER == 'spring-backend' && 'maven' || 'gradle' }}

      - name: Setup Python
        if: env.FOLDER == 'llm-backend'
        uses: actions/setup-python@v4
        with:
          python-version: 3.x
          cache: pip

      # Next.js frontend lint
      - name: Install & Run ESLint
        if: env.FOLDER == 'next-frontend'
        run: |
          cd "$FOLDER"
          npm ci
          npx next lint --format=json --output-file=eslint-report.json

      - name: Upload ESLint report
        if: env.FOLDER == 'next-frontend'
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: ${{ env.FOLDER }}/eslint-report.json

      # Spring backend analysis
      - name: Run Spring backend static analysis
        if: env.FOLDER == 'spring-backend'
        run: |
          cd "$FOLDER"
          chmod +x ./mvnw
          ./mvnw clean verify spotbugs:check checkstyle:check pmd:check -DskipTests

      - name: Upload SpotBugs report
        if: env.FOLDER == 'spring-backend'
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report
          path: ${{ env.FOLDER }}/target/spotbugsXml.xml

      - name: Upload Checkstyle report
        if: env.FOLDER == 'spring-backend'
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: ${{ env.FOLDER }}/target/checkstyle-result.xml

      - name: Upload PMD report
        if: env.FOLDER == 'spring-backend'
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: ${{ env.FOLDER }}/target/pmd.xml

      # Android Kotlin lint & security
      - name: Run ktlint
        if: env.FOLDER == 'android-kotlin'
        run: |
          cd "$FOLDER"
          chmod +x ./gradlew
          ./gradlew ktlintCheck -PreportOutput=ktlint-report.xml || true

      - name: Upload ktlint report
        if: env.FOLDER == 'android-kotlin'
        uses: actions/upload-artifact@v4
        with:
          name: ktlint-report
          path: ${{ env.FOLDER }}/build/reports/ktlint/ktlint.xml

      - name: Run detekt
        if: env.FOLDER == 'android-kotlin'
        run: |
          cd "$FOLDER"
          chmod +x ./gradlew
          ./gradlew detekt

      - name: Upload detekt report
        if: env.FOLDER == 'android-kotlin'
        uses: actions/upload-artifact@v4
        with:
          name: detekt-report
          path: ${{ env.FOLDER }}/build/reports/detekt/detekt.xml

      # LLM backend Python lint & security
      - name: Run Ruff and Bandit
        if: env.FOLDER == 'llm-backend'
        run: |
          cd "$FOLDER"
          pip install -r requirements.txt bandit ruff
          ruff check . --format json --output ruff-report.json
          bandit -r . -f json -o bandit-report.json || true

      - name: Upload Ruff report
        if: env.FOLDER == 'llm-backend'
        uses: actions/upload-artifact@v4
        with:
          name: ruff-report
          path: ${{ env.FOLDER }}/ruff-report.json

      - name: Upload Bandit report
        if: env.FOLDER == 'llm-backend'
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path:
