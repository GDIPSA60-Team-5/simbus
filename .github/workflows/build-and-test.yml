name: Build, Test & Report

on:
  workflow_call:
    inputs:
      folder:
        required: true
        type: string
    secrets:
      MAPS_API_KEY:
        required: true

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      folder: ${{ steps.validate.outputs.folder }}
    steps:
      - name: ✅ Validate Folder
        id: validate
        run: |
          case "${{ inputs.folder }}" in
            next-frontend|spring-backend)
              echo "folder=${{ inputs.folder }}" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Invalid folder: ${{ inputs.folder }}"
              exit 1
              ;;
          esac

  next-frontend:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: next-frontend/package-lock.json

      - name: 📥 Install Dependencies
        run: |
          cd next-frontend
          npm ci

      - name: 🧪 Run Tests
        run: |
          cd next-frontend
          npm test -- --coverage --watchAll=false --ci

      - name: 🏗️ Build Application
        run: |
          cd next-frontend
          npm run build

      - name: 📊 Upload Coverage Reports
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: GDIPSA60-Team-5/simbus
          flags: frontend

      - name: Check if test results exist
        id: check_test_results
        run: |
          if ls next-frontend/test-results.xml 1> /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: 📈 Publish Test Results
        uses: dorny/test-reporter@v1
        if: steps.check_python_test_results.outputs.exists == 'true'
        with:
          name: Next.js Tests
          path: next-frontend/test-results.xml
          reporter: jest-junit

  spring-backend:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ☕ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: 🧪 Run Tests with Coverage
        run: |
          cd spring-backend
          chmod +x ./mvnw
          ./mvnw clean test jacoco:report -Dspring.profiles.active=test

      - name: 🏗️ Package Application
        run: |
          cd spring-backend
          ./mvnw package -DskipTests

      - name: 📊 Generate Test Report
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Spring Boot Tests
          path: spring-backend/target/surefire-reports/*.xml
          reporter: java-junit

      - name: 📈 Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: spring-backend/target/site/jacoco/jacoco.xml
          flags: backend
          name: spring-backend-coverage

      - name: 📊 Upload JaCoCo Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jacoco-coverage-report
          path: spring-backend/target/site/jacoco/
          retention-days: 30

  # Consolidated reporting job
  report-summary:
    if: always()
    needs: [validate, next-frontend, spring-backend]
    runs-on: ubuntu-latest
    steps:
      - name: 📋 Build Summary
        run: |
          echo "## 🚀 Build & Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.next-frontend.result }}" != "skipped" ]]; then
            status="${{ needs.next-frontend.result }}"
            emoji="✅"; [[ "$status" != "success" ]] && emoji="❌"
            echo "| Next.js Frontend | $emoji $status | Build and tests completed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.spring-backend.result }}" != "skipped" ]]; then
            status="${{ needs.spring-backend.result }}"
            emoji="✅"; [[ "$status" != "success" ]] && emoji="❌"
            echo "| Spring Backend | $emoji $status | Tests and build completed |" >> $GITHUB_STEP_SUMMARY
          fi


          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Coverage Reports Available" >> $GITHUB_STEP_SUMMARY
          echo "- 📈 **JaCoCo HTML Report**: Download from [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> $GITHUB_STEP_SUMMARY
          echo "- 📊 **Codecov Dashboard**: [View Online Coverage](https://codecov.io/gh/GDIPSA60-Team-5/simbus)" >> $GITHUB_STEP_SUMMARY
