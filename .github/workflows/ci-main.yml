name: Push CD Pipeline
on:
  push:
    branches: [main, dev, staging]

permissions:
  contents: read
  actions: read
  issues: write
  security-events: write

jobs:
  dockerize:
    uses: ./.github/workflows/dockerize.yml
    with:
      image_tag: ${{ github.sha }}
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  deploy:
    needs: dockerize
    uses: ./.github/workflows/deploy.yml
    with:
      image_tag: ${{ github.sha }}
      terraform_dir: infra/terraform/env/dev
      ansible_dir: infra/ansible
      inventory_file: inventory/dev
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
      BACKEND_ENV_B64: ${{ secrets.BACKEND_ENV_B64 }}
      FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

  dast-scan:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: "http://${{ needs.deploy.outputs.instance_ip }}"
          token: ${{ secrets.GITHUB_TOKEN }}
